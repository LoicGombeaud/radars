<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
                           integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
                           crossorigin=""/>
     <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
             integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
             crossorigin=""></script>
  </head>
  <body>
    <div id="map" style="height: 100%"></div>
    <script>
      // Initialize the map
      var map = L.map('map').setView([44.84026290740844, -0.5753178321765279], 14);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      var back_url = "http://radar.loicag.com";

      function loadStatistics(radarId) {
        return function() {
          const dailyStatisticsReq = new XMLHttpRequest();
          dailyStatisticsReq.addEventListener("load", showDailyStatistics(this));
          dailyStatisticsReq.open("GET", back_url + "/statistics/daily/" + radarId + "/2023/02/16");
          dailyStatisticsReq.send();

        }
      }

      function showDailyStatistics(radarMarker) {
        return function() {
          dailyStatistics = JSON.parse(this.responseText);
          radarMarker.bindPopup(generateDailyStatisticsHTML(dailyStatistics)).openPopup();
        }
      }

      function generateDailyStatisticsHTML(dailyStatistics) {
        n_total = dailyStatistics.n_total;
        v_avg = Math.round(dailyStatistics.v_avg * 10) / 10;
        v_max = dailyStatistics.v_max;
        n_0_to_30 = dailyStatistics.n_0_to_30;
        p_0_to_30 = Math.round(100 * n_0_to_30 / n_total * 10) / 10;
        n_30_to_40 = dailyStatistics.n_30_to_40;
        p_30_to_40 = Math.round(100 * n_30_to_40 / n_total * 10) / 10;
        n_40_to_50 = dailyStatistics.n_40_to_50;
        p_40_to_50 = Math.round(100 * n_40_to_50 / n_total * 10) / 10;

        return "<b>Statistiques du jour</b><br>" +
          "Nombre de mesures : " + n_total + "<br>" +
          "Vitesse moyenne : " + v_avg + " km/h<br>" +
          "Vitesse maximum : " + v_max + " km/h<br>" +
          "Mesures entre 0 et 30 km/h : " + n_0_to_30 + " (" + p_0_to_30 + "%) <br>" +
          "Mesures entre 30 et 40 km/h : " + n_30_to_40 + " (" + p_30_to_40 + "%) <br>" +
          "Mesures entre 40 et 50 km/h : " + n_40_to_50 + " (" + p_40_to_50 + "%) <br>"
      }

      function addRadars() {
        radars = JSON.parse(this.responseText);
        console.log(radars);
        for (const radar of radars) {
          radarMarker = L.marker([radar.latitude, radar.longitude]).addTo(map);
          radarMarker.addEventListener("click", loadStatistics(radar.id));
        }
      }

      const radarReq = new XMLHttpRequest();
      radarReq.addEventListener("load", addRadars);
      radarReq.open("GET", back_url + "/radars");
      radarReq.send();
    </script>
  </body>
</html>
