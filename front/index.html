<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
                           integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
                           crossorigin=""/>
     <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
             integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
             crossorigin=""></script>
     <script src='https://cdn.plot.ly/plotly-2.18.0.min.js'></script>
  </head>
  <body>
    <div id="map" style="height: 100%"></div>
    <script>
      // Initialize the map
      var map = L.map('map').setView([44.84026290740844, -0.5753178321765279], 14);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      var back_url = "http://radars.loicgombeaud.com";

      function loadStatistics(radarId) {
        return function() {
          const hourlyStatisticsReq = new XMLHttpRequest();
          hourlyStatisticsReq.addEventListener("load", showHourlyStatistics);
          hourlyStatisticsReq.open("GET", back_url + "/statistics/hourly/" + radarId + "/yesterday");
          hourlyStatisticsReq.send();

          const dailyStatisticsReq = new XMLHttpRequest();
          dailyStatisticsReq.addEventListener("load", showDailyStatistics);
          dailyStatisticsReq.open("GET", back_url + "/statistics/daily/" + radarId + "/yesterday");
          dailyStatisticsReq.send();
        }
      }

      function showDailyStatistics() {
        dailyStatistics = JSON.parse(this.responseText);

        var data = [{
          type: "pie",
          values: [
            dailyStatistics.n_0_to_30,
            dailyStatistics.n_30_to_40,
            dailyStatistics.n_40_to_50,
            dailyStatistics.n_50_to_60 + dailyStatistics.n_60_to_70 + dailyStatistics.n_over_70,
          ],
          labels: [
            "0 - 30 km/h",
            "31 - 40 km/h",
            "41 - 50 km/h",
            "> 50 km/h",
          ],
          marker: {
            colors: [
              "#92E000",
              "#F58B00",
              "#DE3700",
              "#000000",
            ]
          },
          textinfo: "label+value",
          sort: false,
          direction: "clockwise",
          showlegend: false,
        }];
        var layout = {
          height: 300,
          width: 400,
        };
        Plotly.newPlot(dailyStatistics.sensor_id + "-pie", data, layout);
      }

      function showHourlyStatistics() {
        hourlyStatistics = JSON.parse(this.responseText);

        var data = [
          {
            type: "scatter",
            name: "Vitesse maximum",
            x: hourlyStatistics.map(stat => new Date(stat.datetime).getHours() + "h"),
            y: hourlyStatistics.map(stat => stat.v_max),
            marker: {
              color: "red",
            },
          },
          {
            type: "scatter",
            name: "Vitesse 85%",
            x: hourlyStatistics.map(stat => new Date(stat.datetime).getHours() + "h"),
            y: hourlyStatistics.map(stat => stat.v_85p),
            marker: {
              color: "gray",
            },
          },
          {
            type: "scatter",
            name: "Vitesse moyenne",
            x: hourlyStatistics.map(stat => new Date(stat.datetime).getHours() + "h"),
            y: hourlyStatistics.map(stat => stat.v_avg),
            marker: {
              color: "black",
            },
          },
          {
            type: "scatter",
            name: "Vitesse limite autorisée",
            x: hourlyStatistics.map(stat => new Date(stat.datetime).getHours() + "h"),
            y: hourlyStatistics.map(stat => 30),
            marker: {
              color: "green",
            },
          },
        ]
        var layout = {
          height: 300,
          width: 500,
          yaxis: {
            rangemode: "tozero",
          },
        }
        Plotly.newPlot(hourlyStatistics[0].sensor_id + "-chart", data, layout);
      }

      function addRadars() {
        radars = JSON.parse(this.responseText);
        for (const radar of radars) {
          radarMarker = L.marker([radar.latitude, radar.longitude]).addTo(map);
          radarMarker.bindPopup(
            "<b>Données J - 1</b><br>" +
            "Adresse : " + radar.address +
            "<div id='" + radar.id + "' style='display: flex'><div id='" + radar.id + "-chart'></div><div id='" + radar.id + "-pie'></div></div>", {minWidth: 900});
          radarMarker.addEventListener("click", loadStatistics(radar.id));
        }
      }

      const radarReq = new XMLHttpRequest();
      radarReq.addEventListener("load", addRadars);
      radarReq.open("GET", back_url + "/radars");
      radarReq.send();
    </script>
  </body>
</html>
